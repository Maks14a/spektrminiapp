<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>СПЕКТР</title>

    <link rel="stylesheet" href="styles.css" />

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    </head>

<body>
<div id="overlay-modal" class="overlay-modal" aria-hidden="true">
  <button class="overlay-close" id="overlay-close" aria-label="Закрыть">✖</button>
  <div class="overlay-content" id="overlay-content"></div>
</div>
    <div id="intro-screen">
        <video id="intro-video" autoplay muted playsinline preload="auto">
            <source src="превью.mp4" type="video/mp4" />
            Ваш браузер не поддерживает видео.
        </video>
    </div>

    <div class="container" id="main-content">
        <img src="logo2.png" alt="СПЕКТР" class="logo" />
        <div class="buttons">
            <button id="show-appointment-btn" class="btn btn-primary">ЗАПИСАТЬСЯ</button>
            <button id="show-events-btn" class="btn btn-outline">ЕВЕНТЫ</button>
        </div>

        <img id="about-circle"    src="about.jpg"    alt="О нас"     class="circle-img circle1" />
        <img id="teachers-circle" src="teachers.jpg" alt="Педагоги"  class="circle-img circle2" />

        <div class="circle-text circle1-text" id="about-text">
            <strong>Мы</strong> - Ваш второй дом
        </div>

        <div class="circle-text circle2-text" id="teachers-text">
            <strong>С вами</strong> рука об руку
        </div>

    </div>

    <div class="container" id="appointment-screen">
        <div class="back-button" id="back-to-main-from-appointment"></div>

        <div class="appointment-layout-grid">
            <div class="image-circle"><img src="1.jpg" alt="микрофон" /></div>
            <div class="image-circle"><img src="2.jpg" alt="микрофон" /></div>

            <button id="dikidi-book-btn" class="btn btn-yellow grid-button">ЗАПИСАТЬСЯ</button>

            <div class="image-circle"><img src="3.jpg" alt="микрофон" /></div>
            <div class="image-circle"><img src="4.jpg" alt="микрофон" /></div>
        </div>

        <img src="logo3.png" alt="Логотип" class="footer-logo" />
    </div>

    <div class="container" id="events-screen">
        <div class="back-button" id="back-to-main-from-events"></div>

        <div class="events-carousel-wrapper">
            <div class="events-carousel" id="events-carousel">
                </div>
        </div>

        <div class="events-pagination" id="events-pagination"></div>

        <a href="https://t.me/mmariiism" target="_blank" id="request-btn" class="btn btn-yellow">КУПИТЬ БИЛЕТ</a>

        <img src="logo3.png" alt="Логотип" class="footer-logo-static" />
    </div>

<script>
    document.addEventListener('DOMContentLoaded', () => {

        /* ---------- DOM Element References ---------- */
        const introScreen = document.getElementById('intro-screen');
        const introVideo = document.getElementById('intro-video');
        const mainContent = document.getElementById('main-content');
        const appointmentScreen = document.getElementById('appointment-screen');
        const eventsScreen = document.getElementById('events-screen');
        const showAppointmentBtn = document.getElementById('show-appointment-btn');
        const showEventsBtn = document.getElementById('show-events-btn');
        const backToMainFromAppointmentBtn = document.getElementById('back-to-main-from-appointment');
        const backToMainFromEventsBtn = document.getElementById('back-to-main-from-events');
        const eventsCarousel = document.getElementById('events-carousel');
        const eventsPagination = document.getElementById('events-pagination');
        const allScreens = [mainContent, appointmentScreen, eventsScreen];

        let autoScrollInterval;
        let numOriginalItems = 0;

        /* =================================================================
           BUG FIX: Centralized function to handle screen transitions
           This prevents multiple screens from having the 'show' class at
           the same time, fixing the overlap issue.
           ================================================================= */
        function switchScreen(screenToShow) {
            allScreens.forEach(screen => {
                // Remove 'show' from all screens except the target one
                if (screen !== screenToShow) {
                    screen.classList.remove('show');
                }
            });
            // Add 'show' to the target screen
            screenToShow.classList.add('show');

            // Управление интервалом автоматической прокрутки
            if (screenToShow === eventsScreen) {
                startAutoScroll();
            } else {
                stopAutoScroll();
            }
        }

        function finishIntro() {
            if (introScreen.classList.contains('hidden')) {
                return;
            }

            introScreen.classList.add('hidden');
            const aScreenIsAlreadyShown = allScreens.some(screen => screen.classList.contains('show'));

            if (!aScreenIsAlreadyShown) {
                switchScreen(mainContent);
            }
        }

        introVideo.addEventListener('ended', finishIntro);

        const playPromise = introVideo.play();
        if (playPromise !== undefined) {
            playPromise.catch(error => {
                console.error("Autoplay was blocked:", error);
                finishIntro();
            });
        }

        setTimeout(() => {
            finishIntro();
        }, 5000);

        showAppointmentBtn.onclick = () => switchScreen(appointmentScreen);

        showEventsBtn.onclick = () => {
            switchScreen(eventsScreen);
            loadEvents();
        };

        backToMainFromAppointmentBtn.onclick = () => switchScreen(mainContent);
        backToMainFromEventsBtn.onclick = () => switchScreen(mainContent);

        function getSlideStep() {
            if (eventsCarousel.children.length === 0) return 0;
            const firstItem = eventsCarousel.children[0];
            const itemWidth = firstItem.clientWidth;
            const style = window.getComputedStyle(firstItem);
            const marginRight = parseFloat(style.marginRight);
            return itemWidth + marginRight;
        }

        function createDots() {
            eventsPagination.innerHTML = '';
            if (numOriginalItems === 0) return;

            for (let i = 0; i < numOriginalItems; i++) {
                const dot = document.createElement('span');
                dot.className = 'pagination-dot';
                dot.addEventListener('click', () => {
                    const slideStep = getSlideStep();
                    if (slideStep === 0) return;
                    eventsCarousel.scrollTo({ left: (i + numOriginalItems) * slideStep, behavior: 'smooth' });
                });
                eventsPagination.appendChild(dot);
            }
            updateDots();
        }

        function updateDots() {
            const dots = eventsPagination.querySelectorAll('.pagination-dot');
            if (eventsCarousel.children.length === 0 || numOriginalItems === 0) {
                dots.forEach(dot => dot.classList.remove('active'));
                return;
            }

            const slideStep = getSlideStep();
            if(slideStep === 0) return;

            const adjustedScrollLeft = eventsCarousel.scrollLeft - (numOriginalItems * slideStep);
            let activeIndex = Math.round(adjustedScrollLeft / slideStep);

            if (activeIndex < 0) {
                activeIndex = (numOriginalItems + (activeIndex % numOriginalItems)) % numOriginalItems;
            } else if (activeIndex >= numOriginalItems) {
                activeIndex = activeIndex % numOriginalItems;
            }

            dots.forEach((dot, index) => {
                dot.classList.toggle('active', index === activeIndex);
            });
        }

        eventsCarousel.addEventListener('scroll', () => {
            updateDots();
            handleInfiniteScroll();
        }, { passive: true });

        const API_STATIC = "https://apispectrminiapp-vozmak.amvera.io/static/";
        const API_FILES = "https://apispectrminiapp-vozmak.amvera.io/files";
        const API_TEACHERS_STATIC = "https://apispectrminiapp-vozmak.amvera.io/static/Teachers/";
        const API_TEACHERS_FILES = "https://apispectrminiapp-vozmak.amvera.io/teachers/files";

        async function loadEvents() {
            try {
                const filesResponse = await fetch(API_FILES);
                if (!filesResponse.ok) throw new Error(`HTTP error! status: ${filesResponse.status}`);
                const filesData = await filesResponse.json();
                const originalMediaFiles = filesData.files.filter(filename =>
                    filename.match(/\.(jpeg|jpg|gif|png|webp|avif|mp4)$/i)
                ) || [];

                eventsCarousel.innerHTML = '';

                if (originalMediaFiles.length > 0) {
                    numOriginalItems = originalMediaFiles.length;

                    const clonedBefore = originalMediaFiles.slice(-numOriginalItems);
                    const clonedAfter = originalMediaFiles.slice(0, numOriginalItems);

                    const combinedMedia = [...clonedBefore, ...originalMediaFiles, ...clonedAfter];

                    combinedMedia.forEach(filename => {
                        const mediaUrl = `${API_STATIC}${filename}`;
                        const fileExtension = filename.split('.').pop().toLowerCase();
                        const isVideo = fileExtension === 'mp4';

                        const eventDiv = document.createElement('div');
                        eventDiv.className = 'event-card';

                        let mediaElementHtml;
                        if (isVideo) {
                            mediaElementHtml = `<video src="${mediaUrl}" class="event-image" autoplay loop muted playsinline></video>`;
                        } else {
                            mediaElementHtml = `<img src="${mediaUrl}" alt="Event Image" class="event-image">`;
                        }

                        eventDiv.innerHTML = `${mediaElementHtml}`;
                        eventsCarousel.appendChild(eventDiv);
                    });

                    const slideStep = getSlideStep();
                    if (slideStep > 0) {
                        eventsCarousel.scrollLeft = numOriginalItems * slideStep;
                    }

                    createDots();

                } else {
                    eventsCarousel.innerHTML = '<p class="no-events">Пока нет предстоящих событий.</p>';
                    eventsPagination.innerHTML = '';
                    numOriginalItems = 0;
                }

            } catch (error) {
                console.error('Error loading event files:', error);
                eventsCarousel.innerHTML = '<p class="error-message">Не удалось загрузить события. Попробуйте позже.</p>';
                eventsPagination.innerHTML = '';
                numOriginalItems = 0;
            }
        }

        function startAutoScroll() {
            stopAutoScroll();
            autoScrollInterval = setInterval(() => {
                if (numOriginalItems === 0) return;
                const slideStep = getSlideStep();
                if (slideStep === 0) return;

                eventsCarousel.scrollBy({ left: slideStep, behavior: 'smooth' });
            }, 7000);
        }

        function stopAutoScroll() {
            if (autoScrollInterval) {
                clearInterval(autoScrollInterval);
                autoScrollInterval = null;
            }
        }

        function handleInfiniteScroll() {
            if (numOriginalItems === 0) return;

            const slideStep = getSlideStep();
            if (slideStep === 0) return;

            const currentScrollLeft = eventsCarousel.scrollLeft;

            const startOfRealContent = numOriginalItems * slideStep;
            const endOfRealContent = (numOriginalItems * 2) * slideStep;

            if (currentScrollLeft >= endOfRealContent) {
                eventsCarousel.style.scrollBehavior = 'auto';
                eventsCarousel.scrollLeft = startOfRealContent + (currentScrollLeft - endOfRealContent);
                requestAnimationFrame(() => {
                    eventsCarousel.style.scrollBehavior = 'smooth';
                });
            }
            else if (currentScrollLeft < startOfRealContent) {
                eventsCarousel.style.scrollBehavior = 'auto';
                eventsCarousel.scrollLeft = endOfRealContent - (startOfRealContent - currentScrollLeft);
                requestAnimationFrame(() => {
                    eventsCarousel.style.scrollBehavior = 'smooth';
                });
            }
        }

        /* ---------- DIKIDI Widget Logic (FIXED) ---------- */
        const WIDGET_URL = 'https://dikidi.ru/#widget=190962';
        const btnBook = document.getElementById('dikidi-book-btn');
        btnBook.addEventListener('click', openDikidiModal);

        function openDikidiModal() {
            if (document.querySelector('.dikidi-modal')) return;

            const modal = document.createElement('div');
            modal.className = 'dikidi-modal';

            const modalContent = document.createElement('div');
            modalContent.className = 'dikidi-modal-content';

            const close = document.createElement('span');
            close.className = 'dikidi-close';
            close.textContent = '×';
            close.onclick = () => {
                modal.classList.remove('show');
                setTimeout(() => modal.remove(), 400);
            };

            const loader = document.createElement('div');
            loader.className = 'dikidi-loader';

            const frame = document.createElement('iframe');
            frame.src = WIDGET_URL;
            frame.className = 'dikidi-iframe';
            frame.allow = 'payment *; fullscreen';

            frame.onload = () => {
                loader.remove();
                frame.classList.add('loaded');
            };

            modalContent.appendChild(loader);
            modalContent.appendChild(frame);
            modal.appendChild(close);
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            requestAnimationFrame(() => modal.classList.add('show'));
        }

        /* ---------- Carousel Dragging Logic ---------- */
        let isDown = false;
        let startX;
        let scrollLeft;
        let wheelTimeout;

        function startDragging(e) {
            isDown = true;
            eventsCarousel.classList.add('dragging');
            startX = (e.pageX || e.touches[0].pageX) - eventsCarousel.offsetLeft;
            scrollLeft = eventsCarousel.scrollLeft;
            stopAutoScroll();
        }

        function stopDragging() {
            isDown = false;
            eventsCarousel.classList.remove('dragging');
            if (eventsScreen.classList.contains('show')) {
                startAutoScroll();
            }
        }

        function drag(e) {
            if (!isDown) return;
            e.preventDefault();
            const x = (e.pageX || e.touches[0].pageX) - eventsCarousel.offsetLeft;
            const walk = (x - startX) * 2;
            eventsCarousel.scrollLeft = scrollLeft - walk;
        }

        // Mouse events
        eventsCarousel.addEventListener('mousedown', startDragging);
        eventsCarousel.addEventListener('mouseleave', stopDragging);
        eventsCarousel.addEventListener('mouseup', stopDragging);
        eventsCarousel.addEventListener('mousemove', drag);

        // Touch events
        eventsCarousel.addEventListener('touchstart', startDragging);
        eventsCarousel.addEventListener('touchend', stopDragging);
        eventsCarousel.addEventListener('touchcancel', stopDragging);
        eventsCarousel.addEventListener('touchmove', drag);

        // Mouse Wheel Scrolling
        eventsCarousel.addEventListener('wheel', (e) => {
            if (e.deltaY !== 0) {
                e.preventDefault();
                eventsCarousel.scrollLeft += e.deltaY;
                stopAutoScroll();
                clearTimeout(wheelTimeout);
                wheelTimeout = setTimeout(() => {
                    if (eventsScreen.classList.contains('show')) {
                        startAutoScroll();
                    }
                }, 1000);
            }
        });

        eventsCarousel.style.scrollBehavior = 'smooth';

        // === Модалка «О нас» и «Педагоги» ===
        const aboutCircle    = document.getElementById('about-circle');
        const teachersCircle = document.getElementById('teachers-circle');
        const overlayModal   = document.getElementById('overlay-modal');
        const overlayContent = document.getElementById('overlay-content');
        const overlayClose   = document.getElementById('overlay-close');

        function openOverlay(innerHTML){
        overlayContent.innerHTML = innerHTML;
        overlayModal.classList.add('show');
        document.body.style.overflow = 'hidden';
        }
        function closeOverlay(){
        overlayModal.classList.remove('show');
        overlayContent.classList.remove('gallery-open');
        overlayContent.classList.remove('gallery-fit');
        overlayContent.innerHTML = '';
        document.body.style.overflow = '';
        }

        overlayClose.addEventListener('click', closeOverlay);
        overlayModal.addEventListener('click', (e) => {
        if (e.target === overlayModal) closeOverlay();
        });

        if (aboutCircle) {
        aboutCircle.addEventListener('click', () => {
            overlayContent.classList.remove('gallery-open');
            overlayContent.classList.remove('gallery-fit');
            openOverlay(`
            <div class="about-content">
                <h2 style="margin:0 0 10px 0;">О нас</h2>
                <p><strong>Вокальная студия «Спектр»</strong> – это не просто школа, это второй дом.</p>
                <p><strong>Здесь вы сможете:</strong></p>
                <p>💛 Работать над вокальной техникой и преодолевать страхи.</p>
                <p>💛 Узнавать себя, развивать уверенность и творческую индивидуальность.</p>
                <p>💛 Учиться тому, как голос передаёт настоящие эмоции.</p>
                </ul>
                <p>Мы соблюдаем баланс строгости и уюта: вы почувствуете себя как дома, но при этом будете расти, совершенствоваться и преодолевать свои границы.</p>
                <p><strong>💛 Ваш успех — наша цель, и мы будем рядом с вами, рука об руку.</strong></p>
            </div>
            `);
        });
        }

        if (teachersCircle) {
        teachersCircle.addEventListener('click', () => {
        overlayContent.classList.add('gallery-open');
        overlayContent.classList.add('gallery-fit');
        fetch(API_TEACHERS_FILES)
            .then(response => {
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                return response.json();
            })
            .then(data => {
                const teacherFiles = data.files.filter(filename =>
                    filename.match(/\.(jpeg|jpg|gif|png|webp|avif)$/i)
                ) || [];

                if (teacherFiles.length > 0) {
                    const galleryHTML = `
                        <div class="gallery">
                            <div class="gallery-track" id="gallery-track">
                                ${teacherFiles.map(filename => `
                                    <img src="${API_TEACHERS_STATIC}${filename}"
                                         class="gallery-item"
                                         alt="Преподаватель">`
                                ).join('')}
                            </div>
                            <div class="gallery-dots" id="gallery-dots">
                                ${teacherFiles.map((_, index) => `
                                    <span class="gallery-dot ${index === 0 ? 'active' : ''}"></span>`
                                ).join('')}
                            </div>
                        </div>
                    `;
                    openOverlay(galleryHTML);

                    requestAnimationFrame(() => {
                        const track = document.getElementById('gallery-track');
                        const dots = document.querySelectorAll('#gallery-dots .gallery-dot');
                        let isDown = false;
                        let startX;
                        let scrollLeft;
                        let autoScrollInterval;                        function stepWidth() {
                            const firstItem = track.querySelector('.gallery-item');
                            if (!firstItem) return track.clientWidth;
                            const styles = getComputedStyle(firstItem);
                            const width = firstItem.clientWidth;
                            const marginRight = parseFloat(styles.marginRight) || 0;
                            return width + marginRight;
                        }

                        function updateDots() {
                            const step = stepWidth();
                            if (step === 0) return;
                            const idx = Math.round(track.scrollLeft / step);
                            dots.forEach((dot, i) => {
                                dot.classList.toggle('active', i === idx);
                            });
                        }

                        function startAutoScroll() {
                            stopAutoScroll();
                            autoScrollInterval = setInterval(() => {
                                const step = stepWidth();
                                if (track.scrollLeft >= (track.scrollWidth - track.clientWidth)) {
                                    track.scrollTo({ left: 0, behavior: 'smooth' });
                                } else {
                                    track.scrollBy({ left: step, behavior: 'smooth' });
                                }
                            }, 7000);
                        }

                        function stopAutoScroll() {
                            if (autoScrollInterval) {
                                clearInterval(autoScrollInterval);
                                autoScrollInterval = null;
                            }
                        }

                        function startDragging(e) {
                            isDown = true;
                            track.classList.add('dragging');
                            startX = (e.pageX || e.touches[0].pageX) - track.offsetLeft;
                            scrollLeft = track.scrollLeft;
                            stopAutoScroll();
                        }

                        function stopDragging() {
                            isDown = false;
                            track.classList.remove('dragging');
                            startAutoScroll();
                        }

                        function drag(e) {
                            if (!isDown) return;
                            e.preventDefault();
                            const x = (e.pageX || e.touches[0].pageX) - track.offsetLeft;
                            const walk = (x - startX) * 2;
                            track.scrollLeft = scrollLeft - walk;
                        }

                        track.addEventListener('mousedown', startDragging);
                        track.addEventListener('mouseleave', stopDragging);
                        track.addEventListener('mouseup', stopDragging);
                        track.addEventListener('mousemove', drag);
                        track.addEventListener('touchstart', startDragging);
                        track.addEventListener('touchend', stopDragging);
                        track.addEventListener('touchcancel', stopDragging);
                        track.addEventListener('touchmove', drag);

                        dots.forEach((dot, i) => {
                            dot.addEventListener('click', () => {
                                stopAutoScroll();
                                const step = stepWidth();
                                track.scrollTo({
                                    left: i * step,
                                    behavior: 'smooth'
                                });
                                setTimeout(startAutoScroll, 1000);
                            });
                        });

                        track.addEventListener('scroll', updateDots, { passive: true });
                        window.addEventListener('resize', updateDots);

                        overlayClose.addEventListener('click', stopAutoScroll);
                        overlayModal.addEventListener('click', (e) => {
                            if (e.target === overlayModal) stopAutoScroll();
                        });

                        updateDots();
                        startAutoScroll();
                    });
                } else {
                    openOverlay(`
                        <div class="about-content">
                            <h2>Извините</h2>
                            <p>Не удалось загрузить информацию о преподавателях. Пожалуйста, попробуйте позже.</p>
                        </div>
                    `);
                }
            })
            .catch(error => {
                console.error('Error loading teacher files:', error);
                openOverlay(`
                    <div class="about-content">
                        <h2>Ошибка</h2>
                        <p>Произошла ошибка при загрузке данных. Пожалуйста, попробуйте позже.</p>
                    </div>
                `);
            });
        });
        }
    });
</script>


    <script src="https://dikidi.ru/assets/js/widget_record/widget2.min.js?v=1735141723"></script>
</body>
</html>
